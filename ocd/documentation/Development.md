# OKIT Open Cloud Designer Development Guide

The following guide will explain how OKIT-Ocd can be extended to add additional resource and Cloud Providers. It will explain which files will need to be created/modified and how to customise the resources.
The core code used for Cloud Resources is Autogenerated as part of the build cycle and we will explain how to extend this process to both implement new resources for an existing cloud provider and add new cloud providers.

As a working example we will implement Google (GCP) as a new Cloud Provider. This will show what files need to be created and how the naming convention within the files and works.

## Naming Convention
All code generated and manual created witin the OKIT-Ocd packages must conform to the following naming standards. This allow for the simple runtime generation of Namespace names, Class names etc.

- **Interface Names**: Names must start with the provider name with an initial Capital; e.g. export interface **Google**ComputeNetwork
- **Namespace Names**: Names must start with the provider name with an initial Capital; e.g. export namespace **Google**ComputeNetwork
- **Class Names**:     Names must start with the provider name with an initial Capital; e.g. export class **Google**ComputeNetworkClient
- **File Names**:      Names must start with the provider name with an initial Capital; e.g. **Google**ComputeNetwork.ts
- **Function Names**:  Names must contain the provider name with an initial Capital; e.g. export function get**Google**Resources(design: OcdDesign)
- **Directory Names**: Names must be the provider name; e.g. **google**
- **JSON Elements**:   Names must be the provider name; e.g. **google**

## Code Generation

### ocd/packages/codegen
#### src/importer/GoogleTerraformSchemaImporter.ts

#### src/importer/data/GoogleConditionalElements.ts
#### src/importer/data/GoogleElementOverrides.ts
#### src/importer/data/GoogleIgnoreElements.ts
#### src/importer/data/GoogleResourceMap.ts

#### src/generator/GoogleMarkdownGenerator.ts
#### src/generator/GoogleModelGenerator.ts
#### src/generator/GooglePropertiesGenerator.ts
#### src/generator/GoogleTabularGenerator.ts
#### src/generator/GoogleTerraformGenerator.ts
#### src/generator/GoogleValidatorGenerator.ts

#### src/generator/data/GoogleCommonResourceProperties.ts
#### src/generator/data/GoogleMetadataOverrides.ts

### ocd/packages/codegen-cli
#### src/ocd-codegen.ts
#### package.json

## Provider Specific Code
Although the Code Generation will create the majority of the code required for implementing a new Provider some additional modifications and code will need to be written. The following shows the additional functionaly required to implement the new (GCP) provider/
### ocd/packages/model
#### src/provider/google/GoogleResource.ts
#### src/OcdDesign.ts
```typescript
export interface GoogleResources {
    [key: string]: any[]
}
```
```typescript
export interface GoogleModel extends OcdBaseModel {}
```
```typescript
export interface OcdDesign {
    metadata: OcdMetadata
    model: {
        oci: OciModel
        aws?: AwsModel
        azure: AzureModel
        google: GoogleModel
        general: GeneralModel
    },
    view: OcdView,
    userDefined: OcdUserDefined
}
```
```typescript
// Model Methods
export function getResourceLists(design: OcdDesign) {return {...getOciResourceLists(design), ...getAzureResourceLists(design), ...getGoogleResourceLists(design), ...getGeneralResourceLists(design)}}
export function getResources(design: OcdDesign) {return [...getOciResources(design), ...getAzureResources(design), ...getGoogleResources(design), ...getGeneralResources(design)]}
```
```typescript
// Google
export function getGoogleResourceLists(design: OcdDesign) {return Object.hasOwn(design.model, 'google') ? design.model.google.resources : {}}
export function getGoogleResourceList(design: OcdDesign, key: string) {return Object.hasOwn(design.model, 'google') && Object.hasOwn(design.model.google.resources, key) ? design.model.google.resources[key] : []}
export function getGoogleResources(design: OcdDesign) {return Object.hasOwn(design.model, 'google') ? Object.values(design.model.google.resources).filter((val) => Array.isArray(val)).reduce((a, v) => [...a, ...v], []) : []}
```
#### src/index.js
```typescript
// Google
export { GoogleResources } from './OcdDesign'
export { GoogleResource } from './provider/google/GoogleResource'
export * as GoogleModelResources from './provider/google/resources'
export * as GoogleResourceValidation from './validator/provider/google/resources'
```

### ocd/packages/desktop
#### src/components/OcdDocument.ts
##### imports
```typescript
import { OcdAutoLayout, OcdDesign, OcdViewPage, OcdViewCoords, OcdViewLayer, OcdBaseModel, OcdViewPoint, OcdViewCoordsStyle, OcdResource, PaletteResource, 
    OciModelResources, OciResource,
    AzureModelResources, AzureResource, 
    GoogleModelResources, GoogleResource,
    GeneralModelResources, GeneralResource } from '@ocd/model'
```

```typescript
getGoogleResourcesObject() {return this.design.model.google.resources}

addGoogleReasourceToList(key: string, modelResource: GoogleResource) {
    if (!Object.hasOwn(this.design.model, 'google')) this.design.model.google = {resources: {}, vars: []}
    if (!Object.hasOwn(this.design.model.google.resources, key)) this.design.model.google.resources[key] = []
    this.design.model.google.resources[key].push(modelResource)
}

addGoogleResource(paletteResource: PaletteResource, compartmentId: string): OcdAddResourceResponse {
    const resourceList = paletteResource.class.split('-').slice(1).join('_')
    const resourceClass = paletteResource.class.toLowerCase().split('-').map((w) => `${w.charAt(0).toUpperCase()}${w.slice(1)}`).join('')
    const resourceNamespace: string = `${resourceClass}`
    // @ts-ignore 
    const client = GoogleModelResources[resourceNamespace]
    console.debug('OcdDocument: Namespace',resourceNamespace , client)
    if (client) {
        const modelResource = client.newResource()
        modelResource.compartmentId = compartmentId
        console.debug('OcdDocument:', modelResource)
        this.addGoogleReasourceToList(resourceList, modelResource)
        const response: OcdAddResourceResponse = {modelResource: modelResource, additionalResources: []}
        const additionalResources = client.getAdditionalResources?.() // Use Optional Chaining to test if function exists
        if (additionalResources) {
            console.debug('OcdDocument: Creating Google Additional Resources', additionalResources)
            additionalResources.forEach((r: PaletteResource) => {
                const additionalResource = this.addGoogleResource(r, compartmentId).modelResource
                if (additionalResource) {
                    response.additionalResources.push(additionalResource)
                    this.setResourceParent(additionalResource.id, modelResource.id)
                    client.setAdditionalResourceValues?.(modelResource, additionalResource)
                }
            })
        }
        return response
    } else {
        alert(`Google Resource ${resourceClass} has not yet been implemented.`)
        return {modelResource: undefined, additionalResources: []}
    }
}
```

```typescript
addResource(paletteResource: PaletteResource, compartmentId: string): OcdAddResourceResponse {
    switch(paletteResource.provider) {
        case 'oci':
            return this.addOciResource(paletteResource, compartmentId)
        case 'azure':
            return this.addAzureResource(paletteResource, compartmentId)
        case 'google':
            return this.addGoogleResource(paletteResource, compartmentId)
        case 'general':
            return this.addGeneralResource(paletteResource, compartmentId)
        default:
            alert(`Provider ${paletteResource.provider} has not yet been implemented.`)
            return {modelResource: undefined, additionalResources: []}
    }
}
```

#### src/components/OcdProperties.tsx
##### imports
```typescript
import { AzureResources, OcdDesign, OcdResource, OcdVariable, OcdViewCoordsStyle, OcdViewPage, OciDefinedTag, OciFreeformTag, OciResourceValidation, OciResources, OcdValidationResult, GoogleResources } from '@ocd/model'
import * as googleResources from './properties/provider/google/resources'
```

#####Â Resource Proxy 
Add Provider (Google) specific function to get the Resources proxy from the generated set of proxies.
```typescript
const getGoogleResourceProxy = (ocdDocument: OcdDocument, selectedModelResource: OcdResource, ocdCache: OcdCacheData) => {
    const provider = selectedModelResource.provider
    const resourceType = selectedModelResource.resourceType
    const resourceProxyName = `${OcdUtils.toTitleCase(provider)}${resourceType}Proxy`
    console.debug(`> OcdProperies: OcdResourceProperties: Render(GoogleProxy(${resourceProxyName}))`, selectedModelResource)
    //@ts-ignore
    return Object.hasOwn(googleResources, resourceProxyName) ? googleResources[resourceProxyName].proxyResource(ocdDocument, selectedModelResource, ocdCache) : selectedModelResource
}
```

Update the common **getSelectedResourceProxy** to check for the new provider(google) and call the provider specific function.
```typescript
const getSelectedResourceProxy = (ocdDocument: OcdDocument, selectedModelResource: OcdResource, ocdCache: OcdCacheData) => {    
    const provider = selectedModelResource ? selectedModelResource.provider : ''
    console.debug('OcdProperties: getSelectedResourceProxy:', selectedModelResource)
    switch (provider) {
        case 'azure':
            return getAzureResourceProxy(ocdDocument, selectedModelResource, ocdCache)
        case 'google':
            return getGoogleResourceProxy(ocdDocument, selectedModelResource, ocdCache)
        case 'oci':
            return getOciResourceProxy(ocdDocument, selectedModelResource, ocdCache)
        default:
            return selectedModelResource
    }
}
```

##### Resource Properties
Update the **getResourceProperties** to check for the new provider (google) and return the Resource Namespace for the appropriate imported resources.
```typescript
const getResourceProperties = (selectedModelResource: OcdResource) => {
    const provider = selectedModelResource ? selectedModelResource.provider : ''
    const resourceType = selectedModelResource ? selectedModelResource.resourceType : ''
    const resourceJSXMethod = `${OcdUtils.toTitleCase(provider)}${resourceType}`
    console.debug(`> OcdProperies: OcdResourceProperties: Render(JMX(${resourceJSXMethod}))`)
    switch (provider) {
        case 'azure':
            // @ts-ignore 
            return azureResources[resourceJSXMethod]
        case 'google':
            // @ts-ignore 
            return googleResources[resourceJSXMethod]
        case 'oci':
            // @ts-ignore 
            return ociResources[resourceJSXMethod]
        default:
            return undefined
    }
}
```

##### Resource Validation
Add Provider (Google) specific function to get the Resources Validation class from the generated set of validation classes.
```typescript
const getGoogleResourceValidationResults = (ocdDocument: OcdDocument, selectedModelResource: OcdResource): OcdValidationResult[] => {
    const azureResources: GoogleResources = ocdDocument.getGoogleResourcesObject()
    // @ts-ignore 
    const ResourceValidation = GoogleResourceValidation[resourceValidationMethod(selectedModelResource)]
    const validationResults = ResourceValidation ? ResourceValidation.validateResource(selectedModelResource, azureResources) : []
    return validationResults
}

```

Update the **getResourceValidationResults** to check for the new provider (google) and return the Resource specific function.
```typescript
const getResourceValidationResults = (ocdDocument: OcdDocument, selectedModelResource: OcdResource): OcdValidationResult[] => {
    const provider = selectedModelResource ? selectedModelResource.provider : ''
    switch (provider) {
        case 'azure': 
            return getAzureResourceValidationResults(ocdDocument, selectedModelResource)
        case 'google': 
            return getGoogleResourceValidationResults(ocdDocument, selectedModelResource)
        case 'oci': 
            return getOciResourceValidationResults(ocdDocument, selectedModelResource)
        default:
            return []
    }
}
```

#### src/css/google-theme.css

### ocd/packages/export
#### src/OcdExporter.ts
#### src/markdown/provider/google/GoogleMarkdownResource.ts
#### src/terraform/provider/google/GoogleTerraformResource.ts
#### src/terraform/GoogleExporter.ts
#### src/terraform/OcdTerraformExporter.ts
