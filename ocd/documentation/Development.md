# OKIT Open Cloud Designer Development Guide

The following guide will explain how OKIT-Ocd can be extended to add additional resource and Cloud Providers. It will explain which files will need to be created/modified and how to customise the resources.
The core code used for Cloud Resources is Autogenerated as part of the build cycle and we will explain how to extend this process to both implement new resources for an existing cloud provider and add new cloud providers.

As a working example we will implement Google (GCP) as a new Cloud Provider. This will show what files need to be created and how the naming convention within the files and works.

## Naming Convention
All code generated and manual created witin the OKIT-Ocd packages must conform to the following naming standards. This allow for the simple runtime generation of Namespace names, Class names etc.

- Namespace Names: 

## Code Generation

### ocd/packages/codegen
#### src/importer/GcpTerraformSchemaImporter.ts

#### src/importer/data/GcpConditionalElements.ts
#### src/importer/data/GcpElementOverrides.ts
#### src/importer/data/GcpIgnoreElements.ts
#### src/importer/data/GcpResourceMap.ts

#### src/generator/GcpMarkdownGenerator.ts
#### src/generator/GcpModelGenerator.ts
#### src/generator/GcpPropertiesGenerator.ts
#### src/generator/GcpTabularGenerator.ts
#### src/generator/GcpTerraformGenerator.ts
#### src/generator/GcpValidatorGenerator.ts

#### src/generator/data/GcpCommonResourceProperties.ts
#### src/generator/data/GcpMetadataOverrides.ts

### ocd/packages/codegen-cli
#### src/ocd-codegen.ts
#### package.json

## Provider Specific Code
Although the Code Generation will create the majority of the code required for implementing a new Provider some additional modifications and code will need to be written. The following shows the additional functionaly required to implement the new (GCP) provider/
### ocd/packages/model
#### src/provider/gcp/GcpResource.ts
#### src/OcdDesign.ts
```typescript
export interface GcpResources {
    [key: string]: any[]
}
```
```typescript
export interface GcpModel extends OcdBaseModel {}
```
```typescript
export interface OcdDesign {
    metadata: OcdMetadata
    model: {
        oci: OciModel
        aws?: AwsModel
        azure: AzureModel
        gcp: GcpModel
        general: GeneralModel
    },
    view: OcdView,
    userDefined: OcdUserDefined
}
```
```typescript
// Model Methods
export function getResourceLists(design: OcdDesign) {return {...getOciResourceLists(design), ...getAzureResourceLists(design), ...getGcpResourceLists(design), ...getGeneralResourceLists(design)}}
export function getResources(design: OcdDesign) {return [...getOciResources(design), ...getAzureResources(design), ...getGcpResources(design), ...getGeneralResources(design)]}
```
```typescript
// Gcp
export function getGcpResourceLists(design: OcdDesign) {return Object.hasOwn(design.model, 'gcp') ? design.model.gcp.resources : {}}
export function getGcpResourceList(design: OcdDesign, key: string) {return Object.hasOwn(design.model, 'gcp') && Object.hasOwn(design.model.gcp.resources, key) ? design.model.gcp.resources[key] : []}
export function getGcpResources(design: OcdDesign) {return Object.hasOwn(design.model, 'gcp') ? Object.values(design.model.gcp.resources).filter((val) => Array.isArray(val)).reduce((a, v) => [...a, ...v], []) : []}
```
#### src/index.js
```typescript
// Gcp
export { GcpResources } from './OcdDesign'
export { GcpResource } from './provider/gcp/GcpResource'
export * as GcpModelResources from './provider/gcp/resources'
export * as GcpResourceValidation from './validator/provider/gcp/resources'
```

### ocd/packages/desktop
#### src/components/OcdDocument.ts
##### imports
```typescript
import { OcdAutoLayout, OcdDesign, OcdViewPage, OcdViewCoords, OcdViewLayer, OcdBaseModel, OcdViewPoint, OcdViewCoordsStyle, OcdResource, PaletteResource, 
    OciModelResources, OciResource,
    AzureModelResources, AzureResource, 
    GcpModelResources, GcpResource,
    GeneralModelResources, GeneralResource } from '@ocd/model'
```

```typescript
getGcpResourcesObject() {return this.design.model.gcp.resources}

addGcpReasourceToList(key: string, modelResource: GcpResource) {
    if (!Object.hasOwn(this.design.model, 'gcp')) this.design.model.gcp = {resources: {}, vars: []}
    if (!Object.hasOwn(this.design.model.gcp.resources, key)) this.design.model.gcp.resources[key] = []
    this.design.model.gcp.resources[key].push(modelResource)
}

addGcpResource(paletteResource: PaletteResource, compartmentId: string): OcdAddResourceResponse {
    const resourceList = paletteResource.class.split('-').slice(1).join('_')
    const resourceClass = paletteResource.class.toLowerCase().split('-').map((w) => `${w.charAt(0).toUpperCase()}${w.slice(1)}`).join('')
    const resourceNamespace: string = `${resourceClass}`
    // @ts-ignore 
    const client = GcpModelResources[resourceNamespace]
    console.debug('OcdDocument: Namespace',resourceNamespace , client)
    if (client) {
        const modelResource = client.newResource()
        modelResource.compartmentId = compartmentId
        console.debug('OcdDocument:', modelResource)
        this.addGcpReasourceToList(resourceList, modelResource)
        const response: OcdAddResourceResponse = {modelResource: modelResource, additionalResources: []}
        const additionalResources = client.getAdditionalResources?.() // Use Optional Chaining to test if function exists
        if (additionalResources) {
            console.debug('OcdDocument: Creating Gcp Additional Resources', additionalResources)
            additionalResources.forEach((r: PaletteResource) => {
                const additionalResource = this.addGcpResource(r, compartmentId).modelResource
                if (additionalResource) {
                    response.additionalResources.push(additionalResource)
                    this.setResourceParent(additionalResource.id, modelResource.id)
                    client.setAdditionalResourceValues?.(modelResource, additionalResource)
                }
            })
        }
        return response
    } else {
        alert(`Gcp Resource ${resourceClass} has not yet been implemented.`)
        return {modelResource: undefined, additionalResources: []}
    }
}
```

```typescript
addResource(paletteResource: PaletteResource, compartmentId: string): OcdAddResourceResponse {
    switch(paletteResource.provider) {
        case 'oci':
            return this.addOciResource(paletteResource, compartmentId)
        case 'azure':
            return this.addAzureResource(paletteResource, compartmentId)
        case 'gcp':
            return this.addGcpResource(paletteResource, compartmentId)
        case 'general':
            return this.addGeneralResource(paletteResource, compartmentId)
        default:
            alert(`Provider ${paletteResource.provider} has not yet been implemented.`)
            return {modelResource: undefined, additionalResources: []}
    }
}
```

#### src/components/OcdProperties.tsx
##### imports
```typescript
import { AzureResources, OcdDesign, OcdResource, OcdVariable, OcdViewCoordsStyle, OcdViewPage, OciDefinedTag, OciFreeformTag, OciResourceValidation, OciResources, OcdValidationResult, GcpResources } from '@ocd/model'
import * as gcpResources from './properties/provider/gcp/resources'
```

#####Â Resource Proxy 
Add Provider (Gcp) specific function to get the Resources proxy from the generated set of proxies.
```typescript
const getGcpResourceProxy = (ocdDocument: OcdDocument, selectedModelResource: OcdResource, ocdCache: OcdCacheData) => {
    const provider = selectedModelResource.provider
    const resourceType = selectedModelResource.resourceType
    const resourceProxyName = `${OcdUtils.toTitleCase(provider)}${resourceType}Proxy`
    console.debug(`> OcdProperies: OcdResourceProperties: Render(GcpProxy(${resourceProxyName}))`, selectedModelResource)
    //@ts-ignore
    return Object.hasOwn(gcpResources, resourceProxyName) ? gcpResources[resourceProxyName].proxyResource(ocdDocument, selectedModelResource, ocdCache) : selectedModelResource
}
```

Update the common **getSelectedResourceProxy** to check for the new provider(gcp) and call the provider specific function.
```typescript
const getSelectedResourceProxy = (ocdDocument: OcdDocument, selectedModelResource: OcdResource, ocdCache: OcdCacheData) => {    
    const provider = selectedModelResource ? selectedModelResource.provider : ''
    console.debug('OcdProperties: getSelectedResourceProxy:', selectedModelResource)
    switch (provider) {
        case 'azure':
            return getAzureResourceProxy(ocdDocument, selectedModelResource, ocdCache)
        case 'gcp':
            return getGcpResourceProxy(ocdDocument, selectedModelResource, ocdCache)
        case 'oci':
            return getOciResourceProxy(ocdDocument, selectedModelResource, ocdCache)
        default:
            return selectedModelResource
    }
}
```

##### Resource Properties
Update the **getResourceProperties** to check for the new provider (gcp) and return the Resource Namespace for the appropriate imported resources.
```typescript
const getResourceProperties = (selectedModelResource: OcdResource) => {
    const provider = selectedModelResource ? selectedModelResource.provider : ''
    const resourceType = selectedModelResource ? selectedModelResource.resourceType : ''
    const resourceJSXMethod = `${OcdUtils.toTitleCase(provider)}${resourceType}`
    console.debug(`> OcdProperies: OcdResourceProperties: Render(JMX(${resourceJSXMethod}))`)
    switch (provider) {
        case 'azure':
            // @ts-ignore 
            return azureResources[resourceJSXMethod]
        case 'gcp':
            // @ts-ignore 
            return gcpResources[resourceJSXMethod]
        case 'oci':
            // @ts-ignore 
            return ociResources[resourceJSXMethod]
        default:
            return undefined
    }
}
```

##### Resource Validation
Add Provider (Gcp) specific function to get the Resources Validation class from the generated set of validation classes.
```typescript
const getGcpResourceValidationResults = (ocdDocument: OcdDocument, selectedModelResource: OcdResource): OcdValidationResult[] => {
    const azureResources: GcpResources = ocdDocument.getGcpResourcesObject()
    // @ts-ignore 
    const ResourceValidation = GcpResourceValidation[resourceValidationMethod(selectedModelResource)]
    const validationResults = ResourceValidation ? ResourceValidation.validateResource(selectedModelResource, azureResources) : []
    return validationResults
}

```

Update the **getResourceValidationResults** to check for the new provider (gcp) and return the Resource specific function.
```typescript
const getResourceValidationResults = (ocdDocument: OcdDocument, selectedModelResource: OcdResource): OcdValidationResult[] => {
    const provider = selectedModelResource ? selectedModelResource.provider : ''
    switch (provider) {
        case 'azure': 
            return getAzureResourceValidationResults(ocdDocument, selectedModelResource)
        case 'gcp': 
            return getGcpResourceValidationResults(ocdDocument, selectedModelResource)
        case 'oci': 
            return getOciResourceValidationResults(ocdDocument, selectedModelResource)
        default:
            return []
    }
}
```

#### src/css/gcp-theme.css

### ocd/packages/export
#### src/OcdExporter.ts
#### src/markdown/provider/gcp/GcpMarkdownResource.ts
#### src/terraform/provider/gcp/GcpTerraformResource.ts
#### src/terraform/GcpExporter.ts
#### src/terraform/OcdTerraformExporter.ts
